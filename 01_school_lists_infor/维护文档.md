# 主机登录信息

| 主机IP            | 端口 | 密码                                         | 备注                       |
| ----------------- | ---- | -------------------------------------------- | -------------------------- |
| SVN-10.1.250.197  | 22   | YxikOk+1Cy9l9edXu1CfyiLtP0YO2KRnimWS+4RsFUM= | 丹棱迁移，只需更换IP即可   |
| CMDB-10.39.240.56 | 4344 | YxikOk+1Cy9l9edXu1CfyiLtP0YO2KRnimWS+4RsFUM= | CMDB/网络小阿噗/混合云监控 |
| ELK-10.39.240.55  | 4344 | YxikOk+1Cy9l9edXu1CfyiLtP0YO2KRnimWS+4RsFUM= | 无线数据获取/日志收集      |

## SVN

一般这是修改账号信息，不需要备份，其他不用维护

```shell
启动管理: 
svnserve -d -r /opt/svn/repos/

关闭进程: 
kill -15 PID

配置路径:
[root@TAL-Networker-SVN ~]# cd /opt/svn/repos/trunk/
conf/       db/         format      hooks/      locks/      README.txt 

[root@TAL-Networker-SVN conf]# ls
authz<授权文件>  passwd<密码文件>  svnserve.conf
```

## CMDB

进程管理使用supervisorctl

```shell
idc_monitor:uvicorn-0            RUNNING   pid 16254, uptime 17 days, 18:49:54   # 混合云监控进程
mongo-connector                  RUNNING   pid 12612, uptime 263 days, 12:25:21  # CMDB-Mongo数据库同步到ES进程
mongod                           RUNNING   pid 12613, uptime 263 days, 12:25:21  # 数据库进程
uvicorn:uvicorn-0                RUNNING   pid 15826, uptime 221 days, 21:12:06  # 网络小阿噗进程
uwsgi                            RUNNING   pid 16167, uptime 191 days, 19:14:58  # CMDB后端进程
```

CMDB机器上有CMDB、网络小阿噗机器人、混合云监控三大系统，web root目录均在/usr/share/nginx/html/下

```
[root@CMDB html]# ls
404.html  50x.html  backup  IDC_P2P_Monitor  IDC_P2P_Monitor_Backup  IDC_P2P_Monitor_Backup2  index.html  network_robot  nginx-logo.png  poweredby.png  PYTHON-CMDB  static
```

CMDB-前后端分离

```
systemctl restart|start|stop nginxd进行管理

前端代码主要是index.html及static文件夹，由npm run build构建后在源码dist目录下，覆盖原文件即可(建议提前备份)
```

![image-20211011111535636](/Users/tal/Library/Application Support/typora-user-images/image-20211011111535636.png)

```
维护目前是修改值班表信息人员:page/xxxRota.vue页面里的姓名、电话更新后，执行npm run build即可
```

![image-20211011111613842](/Users/tal/Library/Application Support/typora-user-images/image-20211011111613842.png)

```shell
后端代码路径在/usr/share/nginx/html/PYTHON-CMDB, 进入即可看到Python源码, 除了核心逻辑还有与设备配置备份的定时任务，目前不需要维护，保持文档运行即可

#####BackUp Config ###
1 0 * * 1 cd /usr/share/nginx/html/PYTHON-CMDB/api_1_0;/usr/bin/python  Speiyou_AutoAddDeviceAdmin.py >/dev/null 2>&1
1 1 * * 1 cd /usr/share/nginx/html/PYTHON-CMDB/api_1_0;/usr/bin/python  DeviceTypeSShDetect.py >/dev/null 2>&1
30 1 * * 1 cd /usr/share/nginx/html/PYTHON-CMDB/api_1_0;/usr/bin/python  SetDeviceInfo.py >/dev/null 2>&1
1 1 * * 2 cd /usr/share/nginx/html/PYTHON-CMDB/api_1_0;/usr/bin/python  BackupDeviceConfig.py >/dev/null 2>&1
30 2 * * 2 cd /usr/share/nginx/html/PYTHON-CMDB/api_1_0;/usr/bin/python  ReBackupDevice.py >/dev/null 2>&1
1 3 * * 2 cd /usr/share/nginx/html/PYTHON-CMDB/api_1_0;/usr/bin/python  ReBackupDevice.py >/dev/null 2>&1
30 3 * * 2 cd /usr/share/nginx/html/PYTHON-CMDB/api_1_0;/usr/bin/python  ReBackupDevice.py >/dev/null 2>&1

####MongoDB Backup####  备份会同步到ELK主机的/opt/cmdbackup
1 2 * * * /usr/local/bin/mongo-oplog-backup backup --dir /home/cmdb/dbackup/ --full > /dev/null 2>&1
*/30 * * * * /usr/local/bin/mongo-oplog-backup backup --dir /home/cmdb/dbackup/ --oplog > /dev/null 2>&1
1 3 * * * /usr/local/bin/mongo-oplog-backup rotate --dir /home/cmdb/dbackup/ --keepDays=15 > /dev/null 2>&1
```

## 混合云监控

URL: http://10.39.240.56:8888/    <登录密码同CMDB，账号由CMDB数据库直接导出到nginx配置文件>

```shell
代码路径: /usr/share/nginx/html/IDC_P2P_Monitor
数据库: mongo -> IDCMonitor -> 

cmdb:PRIMARY> use IDCMonitor
switched to db IDCMonitor

cmdb:PRIMARY> show collections
links   # 存放点对点信息，比如专线号、起始结束位置等等
nodes   # 存放节点信息，比如博兴机房、图标颜色等等

维护操作: 1、需要增加节点时，在nodes里插入数据；需要增加点对点时，在links插入数据，删除反之
         2、注意nodes跟links关系，先有nodes再有links
         3、代码中有短信接口
         4、操作完重启进程即可
```

网络小阿噗机器人

```
代码路径: /usr/share/nginx/html/network_robot
对接知音楼聊天机器人，代码量很少,针对知音楼机器人出口做了firewall策略，如有变更需要添加白名单，否则收不到消息

维护操作: 基本不用维护
```

## ELK系统

日志收集: kibana: http://10.39.240.55:5601/login?next=%2F   账号密码: elastic:hwl@ywb@2019-8 <elasticsearch也是这个>

```
syslog-ng<监听> -> <根据地址段>写文件落盘 -> filebeat<打上业务线标签> -> logstash<结构化日志> -> elasticsearch -> elastalert<报警>

维护操作: 清理磁盘 curl -XDELETE -u elastic:hwl@ywb@2019-8  'http://127.0.0.1:9200/索引名<支持通配符>'
```

```shell
#进程管理
[root@elk cmdbackup]# supervisorctl 
elastalert                       RUNNING   pid 30168, uptime 137 days, 23:29:16  # 日志告警
logstash                         RUNNING   pid 1234, uptime 153 days, 2:16:04 # logstash
其他进程 kibana、elasticsearch、filebeat、syslog-ng均采用systemctl进行管理
```

```shell
#syslog-ng
[root@elk conf.d]# pwd
/etc/syslog-ng/conf.d
[root@elk conf.d]# ls   # 自定义配置均在这里，主要是根据不同IP地址段写到不同的日志，日志路径/opt/syslog-ng
IDC_Line.conf  office_dmk.conf  Speiyou_online.conf  Wireless_AC.conf
```

```shell
#filebeat读取落盘文件并打tag，发送到logstash
[root@elk filebeat]# pwd
/etc/filebeat
[root@elk filebeat]# ls  #只需关注filebeat.yml即可
fields.yml  filebeat.reference.yml  filebeat.yml  modules.d
```

```shell
#logstash配置文件中有一个复杂的grok正则表达式进行日志字段切割
[root@elk filebeat]# cd /etc/logstash/conf.d/
[root@elk conf.d]# ls   #只需关注logstash.conf即可
logstash.conf  logstash.conf.bak  logstash.conf.bak.bak  zhiyinlou.conf.bak
```

```shell
#elasticsearch存储
[root@elk conf.d]# cd /etc/elasticsearch/
[root@elk elasticsearch]# ls   #关注elasticsearch.yml即可，无特殊配置
elastic-certificates.p12  elasticsearch.keystore  elasticsearch.yml  elastic-stack-ca.p12  jvm.options  log4j2.properties  role_mapping.yml  roles.yml  users  users_roles
```

```shell
#elastalert 进行日志告警
[root@elk elasticsearch]# cd /etc/elastalert/rules/
[root@elk rules]# ls   # 所有日志的报警规则均定义在yaml文件中，进行知音楼报警
AC_KeyWord_Alert.yaml    Office_KeyWord_Alert.yaml    Peiyouonline_KeyWord_Alert.yaml  WangXiao_Duplicate_Alert.yaml     WangXiao_Level_LTE_3_DaQun__Alert.yaml  YYZX_KeyWord_Alert.yaml
DMK_KeyWord_Alert.yaml   Office_STP.yaml              ShuangShi_KeyWord_Alert.yaml     WangXiao_KeyWord_Alert.yaml       XXZX_KeyWord_Alert.yaml                 ZJY_KeyWord_Alert.yaml
DXWG_KeyWord_Alert.yaml  OtherIDC_KeyWord_Alert.yaml  SpeiyouM5_KeyWord_Alert.yaml     WangXiao_Level_LTE_3__Alert.yaml  YHZX_Level_LTE_3__Alert.yaml
```

办公网无线WIFI数据收集,都是脚本，搬迁的办公区直接删除即可:

```shell
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/longguan_bq_ruckus_wireless.py &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/eshijie_ruckus_wireless.py &> /dev/null
#*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/zhongdiantou_ruckus_wireless.py &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruckus_zd_wireless.py -ip 10.40.254.250 -index wireless_hailong12f -description hailong12f &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruckus_zd_wireless.py -ip 10.25.136.200 -u wukai -p FI9jySwg_ -index wireless-kemao -description kemao7f &> /dev/null
#*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruckus_zd_wireless.py -ip 10.14.120.200 -index wireless-longguan-nanqu -description longguan_nanqu &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruckus_zd_wireless.py -ip 10.75.1.101 -u wukai -p FI9jySwg_ -index wireless-tbd -description tbd &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruckus_zd_wireless.py -ip 10.26.144.200 -index wireless-zhongdiantou -description zhongdiantou &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruckus_zd_wireless.py -ip 10.25.250.200 -u admin -p f9Dh~Hje3506dB -index wireless_hailong2f -description hailong2f &> /dev/null
#*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruijie_ws6008_wireless.py -ip 10.26.81.10 -index wireless_dinghao16f -description dinghao16f &> /dev/null
#*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruijie_ws6008_wireless.py -ip 10.11.1.20 -index wireless_dayuncun3f -description dayuncun3f &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruijie_ws6008_wireless.py -ip 10.7.11.253 -index wireless_hesheng18f -description hesheng18f &> /dev/null
#*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruijie_ws6008_wireless.py -ip 10.12.1.10 -index wireless_dayuncun2f -description dayuncun2f &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/ruijie_ws6008_wireless.py -ip 10.7.133.110 -index wireless_hesheng6f -description hesheng6f &> /dev/null
#*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/cisco_wlc_wireless_common.py -ip 10.33.255.250 -p aHdseXdiOiFAIy40QmQyQjM5Qjk4 -c xesdhcacti -index wireless_yuelai2f -description yuelai2f &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/cisco_wlc_wireless_common.py -ip 10.1.254.250 -p aHdseXdiOiFAIy40QmQyQjM5Qjk4 -c xesdlcacti -index wireless_danling -description danling &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/cisco_wlc_wireless_common.py -ip 10.1.255.249 -p aHdseXdiOiFAIy40QmQyQjM5Qjk4 -c xesdlcacti -index wireless_danling -description danling &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/cisco_wlc_wireless_common.py -ip 10.30.255.250 -p aHdseXdiOmY5RGh+SGplMzUwNmRC -c xesdhcacti -index wireless_daheng -description daheng &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/cisco_wlc_wireless_common.py -ip 10.26.136.1 -p Q2lzY286MTIzUVdFYXNk -c xesdhcacti -index wireless_hkkjds -description hangkongkejidasha &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/huawei_ws6005_wireless.py -ip 10.26.31.250 -index wireless_kemao20f -description kemao20f &> /dev/null
#*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/huawei_ws6005_kemao7_yingyu.py  -ip 10.32.255.250 -u admin -p 3E7Bl9ssl0 -index wireless_kemao7f_yingyu -description kemao7f_yingyu &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/huawei_ws6005_kemao23f.py -ip 10.25.33.254 -u admin -p admin@2019 -index wireless_kemao23f -description kemao23f_zhikang &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/h3c_wireless_f9.py -ip 10.7.11.102 -index wireless_hesheng8f -description hesheng8f &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/aruba_wireless_common.py -ip 10.27.28.10 -u hwlywb -p f9Dh~Hje3506dB -index wireless_haixing -description haixing  &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/aruba_wireless_common.py -ip 10.28.30.250 -u hwlywb -p f9Dh~Hje3506dB -index wireless_tbd1v1 -description tbd1v1  &> /dev/null
#*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/h3c_wireless.py -ip 10.27.28.2 -index wireless_haixing -description haixing &> /dev/null
*/5 * * * * /usr/local/bin/python3 /root/.Wukai_Script/aruba_wireless.py -ip 10.14.250.107:4343 -u hwlywb -p f9Dh~Hje3506dB -index wireless_wucaicheng -description wucaicheng &> /dev/null
```

